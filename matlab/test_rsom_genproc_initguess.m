clc;
clear;
close all;

nrs = 4;
d = 3;
N = 5;

mindeg = 3;
testdata = testNetwork_params(3, N, 'banded', mindeg);
testdata.mindeg = mindeg;

problem_data.Tijs = G2T(testdata.gijtruth);
problem_data.edges = testdata.E;


tuple.R = stiefelfactory(nrs, d, N);
tuple.T = euclideanfactory(nrs, N);
M = productmanifold(tuple);



% Setup the problem structure with manifold M and cost+grad functions.
problem.M = M;
problem_data.sz = [nrs, d, N];
problem.cost = @(x) cost_genproc(x, problem_data);
problem.grad = @(x) grad_genproc(x, problem_data);
problem.hess = @(x, u) hess_genproc(x, u, problem_data);


% figure(1)
% checkgradient(problem);
% 
% figure(2)
% checkhessian(problem);

R_start = zeros(nrs, d, N);
R_start(:,:,1) = [...
-8.6111316201e-01	-2.4231807714e-01	2.2041231019e-01;
2.9905667201e-01	-3.2397439207e-01	8.9628847729e-01;
4.0690794745e-01	-3.9424233375e-01	-2.3628533360e-01;	
5.8950415130e-02	8.2516393829e-01	3.0373445658e-01];	

R_start(:,:,2) = [ ...
-4.1059440931e-01	-1.1437917202e-01	2.7183095287e-01;
3.5386645467e-01	-8.6801045842e-01	-3.1338931219e-01;
6.3411042845e-01	4.7706138888e-01	-3.7143849333e-01;	
5.5144784689e-01	-7.6731221225e-02	8.3061935791e-01];	

R_start(:,:,3) = [ ...
-2.1430690851e-01	-2.4534556283e-01	-5.3386741786e-01;
-6.2161433491e-01	-6.9622980720e-01	3.1324520402e-01;	
2.0106036221e-01	-3.6483516939e-01	-7.2147848594e-01;	
7.2611493466e-01	-5.6741951813e-01	3.1037367259e-01];	

R_start(:,:,4) = [ ...
-7.1037398226e-01	-5.0679527971e-01	2.7375993632e-01;
3.0531086862e-01	-5.0948717294e-01	-7.0995604558e-01;	
4.2847851248e-02	5.9294792062e-01	2.1311271115e-02;	
6.3270699417e-01	-3.6330996201e-01	6.4850885910e-01];	

R_start(:,:,5) = [ ...
-1.5666248790e-01	5.8716493319e-01	-1.7441611935e-01;	
-5.0524314380e-01	-7.1781280960e-01	1.0920867765e-01;	
-9.6019087979e-02	-1.5821933671e-01	-9.7547959060e-01;	
-8.4318833322e-01	3.3904093130e-01	7.8051587764e-02];	

% T_start = zeros(nrs, N);
T_start = [...
3.2774819472e-01	-1.1292397076e+00	1.3968437082e-01	3.8852371422e-02	2.9319206102e-01;	
7.6930246442e-02	9.2838890252e-02	-1.8538640042e-02	-1.9448161338e-01	1.0684563714e+00;	
2.6546361981e+00	4.6517108840e-02	3.7439802807e-01	1.4314678759e+00	1.0700675098e-01;	
-1.1277842920e+00	-6.4363522916e-02	-3.2549888398e-01	8.7314119356e-02	4.7163430369e-01];	

X_start.R = R_start;
X_start.T = T_start;


%% f
cost_start = rsom_cost_base(X_start, problem_data);
disp("cost_start")
disp(cost_start)

%% grad
grad_test = grad_genproc(X_start, problem_data);
disp("grad_test.R")
disp(grad_test.R)
disp("grad_test.T")
disp(grad_test.T)

%% hess
etaR = zeros(4,3,5);
etaR(:,:,1) = [...
   -0.1101   -0.0482   -0.1842;
    0.0462    0.2060   -0.1011;
    0.2151    0.1224   -0.0164;
   -0.0946    0.1122    0.2315];
etaR(:,:,2) = [...
    0.0360    0.1207    0.0122;
   -0.0125    0.0030    0.0541;
    0.0027    0.1303   -0.0089;
    0.0286    0.0460   -0.0474];
etaR(:,:,3) = [...
   -0.0911   -0.1560   -0.0426;
    0.0180    0.0719    0.0278;
   -0.0361   -0.0415   -0.0031;
    0.0730    0.1054    0.0352];
etaR(:,:,4) = [...
    0.1132    0.1830    0.0406;
    0.0714    0.0587    0.0336;
   -0.1242   -0.0207   -0.0325;
   -0.0165    0.0007    0.0154];
etaR(:,:,5) = [...
   -0.0719    0.0484    0.0168;
   -0.0396   -0.1672    0.1187;
    0.0972   -0.0146   -0.0080;
    0.0692    0.1284    0.0001];

etaT = [
0.135273903247275	-0.139019318227698	0.0606588281885600	-0.0268750194068767	-0.000934510476467760;
-0.0855380392228551	0.0892835989075284	-0.00616224361623335	-0.181513076684276	-0.288707292473232;
0.124548425785915	0.173015734558901	-0.205645153910418	-0.327356415534514	0.211582102502972;
0.142034151555551	-0.176227892510851	-0.0460826904786033	-0.152351113598201	-0.100580511052647];

etaX.R = etaR;
etaX.T = etaT;
hess_test = hess_genproc(X_start, etaX, problem_data);
disp("hess_test.R")
disp(hess_test.R)
disp("hess_test.T")
disp(hess_test.T)

%% Run optimization

[X_out, cost_out, ~, ~] = trustregions(problem, X_start);

T_out = X_out.T;
R_out = X_out.R;

disp("R_out")
disp(R_out)

disp("T_out")
disp(T_out)

disp("cost_out")
disp(cost_out)

%% cpp cost
cpp_cost_R = zeros(nrs, d, N);

cpp_cost_R(:,:,1) = [...
7.9641921048e-01	1.4228732744e-01	-3.2003995296e-01;
1.8531451288e-01	6.3124454213e-01	7.5308380440e-01;	
5.4710574089e-01	-1.7838357072e-01	2.2845554896e-02;	
1.7902592210e-01	-7.4125835319e-01	5.7438427266e-01];	

cpp_cost_R(:,:,2) = [...
1.6686218737e-02	2.5393033725e-01	-8.3198303335e-01;	
9.4871489763e-01	2.9500121735e-01	1.1340494645e-01;	
1.2421514685e-01	-1.7354754529e-01	-5.3490107143e-01;	
2.9022785948e-01	-9.0464076578e-01	-9.3938246303e-02];	

cpp_cost_R(:,:,3) = [...
-8.3243144042e-01	1.4228732744e-01	-2.0920570574e-01;
2.9272896375e-01	6.3124454213e-01	-7.1818273366e-01;	
-4.2918956185e-01	-1.7838357072e-01	-3.4006312810e-01;	
1.9277959121e-01	-7.4125835320e-01	-5.6991543467e-01];	

cpp_cost_R(:,:,4) = [...
-5.0252679169e-01	2.5393033725e-01	6.6328049972e-01;
-7.0086871993e-01	2.9500121735e-01	-6.4938715438e-01;	
-4.1489912598e-01	-1.7354754529e-01	3.5973222566e-01;	
-2.9001478636e-01	-9.0464076578e-01	-9.4594017924e-02];	

cpp_cost_R(:,:,5) = [...
5.5048315342e-01	1.4228732744e-01	6.5854189549e-01;	
-6.5895992571e-01	6.3124454213e-01	4.0896026879e-01;	
1.4733755780e-01	-1.7838357072e-01	5.2738814468e-01;	
-4.9094985301e-01	-7.4125835320e-01	3.4775827135e-01];	

cpp_cost_T = [...
2.7169712990e+00	6.8125159422e+00	1.8302973213e+00	-5.1495923225e+00	-5.1116834886e+00;	
-7.5006700476e+00	-2.3832391840e+00	4.2694622568e+00	3.7190976227e+00	-4.7476817627e+00;	
-5.6523210655e-01	3.8967409040e+00	2.3380373574e+00	-3.2603254727e+00	-4.6015728249e+00;	
-4.5713647240e+00	7.7521542766e-01	4.5830329346e+00	7.8046160063e-01	-2.7583567135e+00];	

cpp_out_X.R = cpp_cost_R;
cpp_out_X.T = cpp_cost_T;


cost_cpp_out = rsom_cost_base(cpp_out_X, problem_data);

disp("cost_cpp_out")
disp(cost_cpp_out)
