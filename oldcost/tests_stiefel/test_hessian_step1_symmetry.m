num_rows_stiefel = 4;
d = 3;
N = 5;


R_manopt_stiefel = stiefelfactory(num_rows_stiefel,d,N);
step1.M = R_manopt_stiefel; %M = manifold

L = [81.8237937948520	112.037661838045	4.73052451928088	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0;
112.037661838045	247.577031200868	1.60014831969606	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0;
4.73052451928088	1.60014831969606	0.526083238650238	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0;
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0;
0	0	0	0	229.285034693104	-88.3580191398148	49.4954861487324	0	0	0	0	0	0	0	0	0	0	0	0	0;
0	0	0	0	-88.3580191398148	181.455563318464	-30.8804053991093	0	0	0	0	0	0	0	0	0	0	0	0	0;
0	0	0	0	49.4954861487324	-30.8804053991093	11.9706656430406	0	0	0	0	0	0	0	0	0	0	0	0	0;
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0;
0	0	0	0	0	0	0	0	269.835490711748	160.727358297256	25.1268150198972	0	0	0	0	0	0	0	0	0;
0	0	0	0	0	0	0	0	160.727358297256	384.319877684063	-8.19784555662784	0	0	0	0	0	0	0	0	0;
0	0	0	0	0	0	0	0	25.1268150198972	-8.19784555662784	6.55648694053350	0	0	0	0	0	0	0	0	0;
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0;
0	0	0	0	0	0	0	0	0	0	0	0	255.844539274558	-73.5994397197616	57.4193278805093	0	0	0	0	0;
0	0	0	0	0	0	0	0	0	0	0	0	-73.5994397197616	144.019017733910	-45.8685417544971	0	0	0	0	0;
0	0	0	0	0	0	0	0	0	0	0	0	57.4193278805093	-45.8685417544971	22.0792535834134	0	0	0	0	0;
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0;
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	156.836401283780	138.475503328774	-6.09759316329436	0;
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	138.475503328774	163.008326733959	-20.1638141928065	0;
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	-6.09759316329436	-20.1638141928065	5.59857570162980	0;
0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0];

P = [-163.472936424418	16.7969898749502	-220.787576755502;
-226.676185679509	15.3756583691586	-485.604306213875;
-9.30386375606613	1.36593705592931	-3.27166335660236;
0	0	0;
57.4391326418379	29.7138027956758	490.947942817551;
-288.823996294331	77.3884850116431	-272.767629301760;
33.9575255364760	-0.504318980545320	112.631391757572;
0	0	0;
258.286911980844	56.8749716789134	568.943337440766;
-175.540257283233	-11.5882399791785	804.871188525147;
50.6067516560441	13.7311217821795	15.5186102881273;
0	0	0;
302.771125130579	56.6740812907377	-446.581860060651;
61.6280844185141	17.7586853231790	320.204743789859;
31.2866647491704	8.92161856257658	-147.960804607440;
0	0	0;
158.064113201787	-14.2872430747735	-386.809444415604;
215.273674904962	-43.6495250509821	-369.165485583123;
-33.6108486755905	11.8134601464868	25.0651163506788;
0	0	0];

step1.ehess = @(x,u) myeuclhess(x,u,L,P);
step1.hess = @(x,u) step1.M.ehess2rhess(x, ...
    myeuclgradient(x,L,P), ...
    myeuclhess(x,u,L,P), ...
    u);



% x = make_rand_stiefel_mat(num_rows_stiefel, d, N);
x = [[0.9987    0.0376   -0.0341;
    0.0355   -0.0363    0.9987;
    0.0363   -0.9986   -0.0376;
    0 0 0];
    [0.3424    0.0419   -0.9386;
    0.8833   -0.3549    0.3064;
   -0.3202   -0.9340   -0.1585;
    0 0 0];
   [-0.8113   -0.0623   -0.5813;
    0.5826   -0.0050   -0.8127;
    0.0477   -0.9980    0.0403;
    0 0 0];
   [-0.7829    0.0325    0.6214;
   -0.5769   -0.4119   -0.7053;
    0.2330   -0.9106    0.3413;
    0 0 0];
   [0.2945    0.0482    0.9544;
   -0.9554    0.0370    0.2930;
   -0.0212   -0.9982    0.0570;
   0 0 0]];

x = matUnstack(x, 4);
v1 = zeros(size(x));
v2 = zeros(size(x));



for ii = 1:N
    v1(:,:,ii) = stiefel_randTangentNormVector(x(:,:,ii));
    v2(:,:,ii) = stiefel_randTangentNormVector(x(:,:,ii));
end

% left_side = zeros(N,1);
% right_side = zeros(N,1);

hess_v1 = step1.hess(x, v1);
hess_v2 = step1.hess(x, v2);
left_side = stiefel_metric(x, v1, hess_v2, 'canonical');
right_side = stiefel_metric(x, v2, hess_v1, 'canonical');

left_side - right_side

hess_v1 = step1.ehess(x, v1);
hess_v2 = step1.ehess(x, v2);
left_side = sum(stiefel_metric(x, v1, hess_v2, 'euclidean'));
right_side = sum(stiefel_metric(x, v2, hess_v1, 'euclidean'));

left_side - right_side



%%
function g = myeuclgradient(x, L_stiefel, P_stiefel)
    g = matUnstack(L_stiefel*matStack(x) + (L_stiefel')*matStack(x) + P_stiefel, size(x, 1));
end
%%
function eucl_hess = myeuclhess(x, u, L, P)
P_3d = matUnstack(P, size(x, 1));
eucl_hess = multiprod3(u, multitransp(x), P_3d) ... 
        + multiprod3(x, multitransp(u), P_3d) ...
        - multiprod3(u, multitransp(P_3d), x) ...
        - multiprod3(x, multitransp(P_3d), u);
eucl_hess = 0.5 .* eucl_hess;
end
%%


% x = val(:,:,1) =
% 
%     0.9981    0.0029    0.0609
%    -0.0609   -0.0149    0.9980
%     0.0038   -0.9999   -0.0147
% 
% 
% val(:,:,2) =
% 
%     0.2676    0.0448   -0.9625
%     0.8985   -0.3724    0.2325
%    -0.3480   -0.9270   -0.1399
% 
% 
% val(:,:,3) =
% 
%    -0.7787    0.0305   -0.6267
%     0.6273    0.0235   -0.7784
%    -0.0090   -0.9993   -0.0374
% 
% 
% val(:,:,4) =
% 
%    -0.8216   -0.0143    0.5699
%    -0.5081   -0.4346   -0.7436
%     0.2583   -0.9005    0.3498
% 
% 
% val(:,:,5) =
% 
%     0.2717    0.0459    0.9613
%    -0.9624    0.0176    0.2712
%    -0.0045   -0.9988    0.0489



% u = val(:,:,1) =
% 
%    -1.3838    2.0036   22.5680
%   -22.5479    3.1157   -1.3292
%     2.1430   -0.0407    3.3179
% 
% 
% val(:,:,2) =
% 
%   -12.3593   14.1476   -2.7781
%     2.8083   -3.8883  -17.0819
%    -2.2525    2.2450   -9.2757
% 
% 
% val(:,:,3) =
% 
%    27.9187   16.8893  -33.8703
%    34.6434   17.0967   28.4358
%    -0.7713    0.9166  -24.3097
% 
% 
% val(:,:,4) =
% 
%    -8.0304    3.7238  -11.4847
%    11.8413   -9.6098   -2.4753
%    -2.2487    4.5788   13.4477
% 
% 
% val(:,:,5) =
% 
%   -19.7471   10.7883    5.0661
%    -5.5550    6.4416  -20.1335
%    -4.2801    0.6093   12.0397